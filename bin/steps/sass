#!/usr/bin/env bash

SASS_BUILD_DIR=$1
SASS_CACHE_DIR=$2

bpwatch start sass

# install sass
puts-step "Installing Sass"
export GEM_HOME=$SASS_BUILD_DIR/.gem/ruby/1.9.1
PATH="$GEM_HOME/bin:$PATH"
if test -d $SASS_CACHE_DIR/ruby/.gem; then
  puts-step "Restoring ruby gems directory from cache"
  cp -r $SASS_CACHE_DIR/ruby/.gem $SASS_BUILD_DIR
  HOME=$SASS_BUILD_DIR gem update sass --user-install --no-rdoc --no-ri
else
  HOME=$SASS_BUILD_DIR gem install sass --user-install --no-rdoc --no-ri
fi

# cache ruby gems sass
rm -rf $SASS_CACHE_DIR/ruby
mkdir -p $SASS_CACHE_DIR/ruby

# If app has a gems directory, cache it.
if test -d $SASS_BUILD_DIR/.gem; then
  puts-step "Caching ruby gems directory for future builds"
  cp -r $SASS_BUILD_DIR/.gem $SASS_CACHE_DIR/ruby
fi

#puts-step "Building runtime environment"
#mkdir -p $BUILD_DIR/.profile.d
#echo "export PATH=\"\$HOME/vendor/node/bin:\$HOME/bin:\$HOME/node_modules/.bin:\$PATH\";" > $BUILD_DIR/.profile.d/nodejs.sh
#echo "export PATH=\"\$HOME/.gem/ruby/1.9.1/bin:\$PATH\"" > $BUILD_DIR/.profile.d/ruby.sh

bpwatch stop sass
