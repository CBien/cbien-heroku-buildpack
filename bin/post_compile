#!/usr/bin/env bash

PYTHON_EXE=`which python`
TABLEAU_SDK_URL="https://downloads.tableau.com/tssoftware/Tableau-SDK-Python-Linux-64Bit-9-3-3.tar.gz"
TABLEAU_SDK_ARCHIVE="tableausdk.tag.gz"
TABLEAU_SDK_PACKAGE="TableauSDK-9300.0.0.0"

# Buildpack Steps.
puts-step() {
    echo "-----> $@"
}

function install_tableausdk {
    cd /tmp
    puts-step "Downloading $TABLEAU_SDK_URL"
    wget -O $TABLEAU_SDK_ARCHIVE $TABLEAU_SDK_URL &> /dev/null
    puts-step "Extracting $TABLEAU_SDK_ARCHIVE"
    tar -xvzf $TABLEAU_SDK_ARCHIVE &> /dev/null
    rm -rf $TABLEAU_SDK_ARCHIVE
    puts-step "Installing $TABLEAU_SDK_PACKAGE"
    cd $TABLEAU_SDK_PACKAGE
    $PYTHON_EXE setup.py install
    puts-step "Cleaning files"
    cd /tmp
    rm -rf $TABLEAU_SDK_PACKAGE
    cd
}

function compile_gettext {
    # Gettext
    export PATH=$HOME/gettext/bin:$PATH
    puts-step "Compiling gettext"
    make PYTHON_EXE=$PYTHON_EXE compilemessages
}

function compile_sass {
    # Sass
    export PATH=$HOME/.gem/bin:$PATH
    puts-step "Compiling sass"
    make PYTHON_EXE=$PYTHON_EXE sass
}

# Execute steps
puts-step "Using python $PYTHON_EXE"
puts-step "env"
env
puts-step "ls"
ls -laR /app/.heroku
puts-step "profile"
cat "$BUILD_DIR/.profile.d/python.sh"
puts-step "steps"
install_tableausdk
compile_gettext
compile_sass

# Apply migrations
if [ "$MIGRATE_ON_DEPLOY" = "1" ]; then
    puts-step "Applying migrations"
    $PYTHON_EXE manage.py migrate --noinput
fi
