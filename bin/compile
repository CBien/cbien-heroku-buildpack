#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

TARGET_DIR=$HOME
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

function install_tableausdk {
    TABLEAU_SDK_URL="https://downloads.tableau.com/tssoftware/Tableau-SDK-Python-Linux-64Bit-9-3-3.tar.gz"
    TABLEAU_SDK_ARCHIVE=tableausdk.tag.gz

    cd /tmp
    wget -O $TABLEAU_SDK_ARCHIVE $TABLEAU_SDK_URL &> /dev/null
    tar -xvzf $TABLEAU_SDK_ARCHIVE &> /dev/null
    rm $TABTLEAU_SDK_ARCHIVE
    python TableauSDK-9300.0.0.0/setup.py install &> /dev/null
    rm -rf TableauSDK-9300.0.0.0
    cd
}

install_tableausdk

# Usage: $ set-env key value
set-env() {
  export $1=$2
}

# Usage: $ set-default-env key value
set-default-env() {
  export $1=${$1:-$2}
}

# Gettext
set-env PATH $HOME/gettext/bin:$PATH
make compilemessages

# Sass
set-env PATH $HOME/.gem/bin:$PATH
make sass

# Migrations
if [ "$MIGRATE_ON_DEPLOY" = "1" ]; then
    python manage.py migrate --noinput
fi
