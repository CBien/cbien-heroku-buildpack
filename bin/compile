#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

TARGET_DIR=$HOME
BUILD_DIR=$1
CACHE_DIR=$2

export LIBRARY_PATH=/app/.heroku/vendor/lib:$BUILD_DIR/.heroku/vendor/lib:/app/.heroku/python/lib
export LD_LIBRARY_PATH=/app/.heroku/vendor/lib:$BUILD_DIR/.heroku/vendor/lib:/app/.heroku/python/lib

cd $BUILD_DIR

# Set context environment variables.
set-env PATH '$HOME/.heroku/python/bin:$PATH'
set-env PYTHONUNBUFFERED true
set-env PYTHONHOME /app/.heroku/python
set-env LIBRARY_PATH '/app/.heroku/vendor/lib:/app/.heroku/python/lib:$LIBRARY_PATH'
set-env LD_LIBRARY_PATH '/app/.heroku/vendor/lib:/app/.heroku/python/lib:$LD_LIBRARY_PATH'
set-default-env LANG en_US.UTF-8
set-default-env PYTHONHASHSEED random
set-default-env PYTHONPATH /app/

# Install sane-default script for WEB_CONCURRENCY environment variable.
cp $ROOT_DIR/vendor/python.webconcurrency.sh $WEBCONCURRENCY_PROFILE_PATH

# Gettext
export PATH=$HOME/gettext/bin:$PATH
make compilemessages

# Sass
export PATH=$HOME/.gem/bin:$PATH
make sass

# Migrations
if [ "$MIGRATE_ON_DEPLOY" = "1" ]; then
    python manage.py migrate --noinput
fi
