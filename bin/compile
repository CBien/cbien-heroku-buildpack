#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

TARGET_DIR=$HOME
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

export LIBRARY_PATH=/app/.heroku/vendor/lib:$BUILD_DIR/.heroku/vendor/lib:/app/.heroku/python/lib
export LD_LIBRARY_PATH=/app/.heroku/vendor/lib:$BUILD_DIR/.heroku/vendor/lib:/app/.heroku/python/lib
PROFILE_PATH="$BUILD_DIR/.profile.d/python.sh"

cd $BUILD_DIR

# Usage: $ set-env key value
set-env() {
  export $1=$2
}

# Usage: $ set-default-env key value
set-default-env() {
  export $1=${$1:-$2}
}

# Set context environment variables.
export PATH="$HOME/.heroku/python/bin:$PATH"
export PYTHONUNBUFFERED=true
export PYTHONHOME=/app/.heroku/python
export LIBRARY_PATH="/app/.heroku/vendor/lib:/app/.heroku/python/lib:$LIBRARY_PATH"
export LD_LIBRARY_PATH="/app/.heroku/vendor/lib:/app/.heroku/python/lib:$LD_LIBRARY_PATH"
export LANG="$LANG:en_US.UTF-8"
export PYTHONHASHSEED="$PYTHONHASHSEED:random"
export PYTHONPATH="$PYTHONPATH:/app/"

# Install sane-default script for WEB_CONCURRENCY environment variable.
cp $ROOT_DIR/vendor/python.webconcurrency.sh $WEBCONCURRENCY_PROFILE_PATH

# Gettext
export PATH=$HOME/gettext/bin:$PATH
make compilemessages

# Sass
export PATH=$HOME/.gem/bin:$PATH
make sass

# Migrations
if [ "$MIGRATE_ON_DEPLOY" = "1" ]; then
    python manage.py migrate --noinput
fi
